id: nz.mega.MEGAsync
sdk: org.kde.Sdk
runtime: org.kde.Platform
runtime-version: 5.15-23.08
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '23.08'
    add-ld-path: .
finish-args:
  - --device=dri
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  - --filesystem=~/MEGA:create
  - --filesystem=~/MEGAsync Downloads:create
  - --filesystem=~/MEGAsync:create
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
command: megasync
rename-icon: mega
copy-icon: true
rename-desktop-file: megasync.desktop
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man
modules:
  - name: MEGAsync
    buildsystem: simple
    build-options:
      env:
        DESKTOP_DESTDIR: /app
    build-commands:
      - cmake -S 'desktop' -B 'build_dir' -DVCPKG_ROOT='vcpkg' -DVCPKG_OVERLAY_PORTS='overlays' -DCMAKE_BUILD_TYPE=Release
      - cmake --build 'build_dir' --target MEGAsync
      - install -D build_dir/src/MEGASync/Release/megasync -t /app/bin/
    sources:
      # Use sd instead of sed for better regex multiline matching
      - type: archive
        url: https://github.com/chmln/sd/releases/download/v1.0.0/sd-v1.0.0-x86_64-unknown-linux-gnu.tar.gz
        sha256: 297202d8cc09cb65c9d7afdfc3f23146371d0c7d7d3448cecab11685d47c709a
        strip-components: 1

      # Download patchelf as required by vcpkg_find_acquire_program(PATCHELF)
      - type: archive
        url: https://github.com/NixOS/patchelf/releases/download/0.14.5/patchelf-0.14.5-x86_64.tar.gz
        sha256: 514bb05d8f0e41ea0a6cb999041acb6aa386662e9ccdbdfbbfca469fb22d44fa
        strip-components: 2
      
      # Download vcpkg which contains the cmake and portfiles of dependencies
      - type: git
        url: https://github.com/microsoft/vcpkg.git
        #tag: '2024.07.12'
        branch: master
        #commit: 1de2026f28ead93ff1773e6e680387643e914ea1
        dest: vcpkg

      # Download vcpkg-tool which will be used by vcpkg-cmake
      - type: file
        url: https://github.com/microsoft/vcpkg-tool/releases/download/2024-07-10/vcpkg-glibc
        sha256: cdf7fdeb1327e20e2a47a6f7c9ec16999ebe29f417a9a673a80ac92c8b4d4243
        dest: vcpkg
        dest-filename: vcpkg
      - type: shell
        commands:
          - chmod +x vcpkg/vcpkg
          - find vcpkg/ports -type f -name 'portfile.cmake' -exec ./sd -f m 'vcpkg_from_.+?\(\s*?OUT_SOURCE_PATH\s+(\S+?)\s[^)]+?REPO\s+(\S+?)\s[^)]+?(PATCHES\s+[^)]+)+\)' 'set($1 "downloads/$2")\nz_vcpkg_apply_patches(\nSOURCE_PATH "$${$1}"\n$3)' {} +;
          - find vcpkg/ports -type f -name 'portfile.cmake' -exec ./sd -f m 'vcpkg_from_.+?\(\s*?OUT_SOURCE_PATH\s+(\S+?)\s[^)]+?REPO\s+(\S+?)\s[^)]+\)' 'set($1 "downloads/$2")' {} +;
          - find vcpkg/ports -type f -name 'portfile.cmake' -exec ./sd -f m '(vcpkg_cmake_configure|vcpkg_configure_\w+)\(' 'file(RENAME $${SOURCE_PATH} $${CURRENT_BUILDTREES_DIR}/$${TARGET_TRIPLET}-$${BUILD_TYPE})\nset(SOURCE_PATH "$${CURRENT_BUILDTREES_DIR}/$${TARGET_TRIPLET}-$${BUILD_TYPE}")\n$1(' {} +;
          - find . -type f -name '*.cmake' -exec ./sd -f m 'vcpkg_find_acquire_program\(PATCHELF\)' '' {} +;
          - find . -type f -name '*.cmake' -exec ./sd -f m '\$\{PATCHELF\}' 'patchelf' {} +;
          - ./sd -f m 'vcpkg_download_distfile\(archive_path[^)]+\)' 'set(archive_path "downloads/meson.tar.gz")' vcpkg/ports/vcpkg-tool-meson/vcpkg-port-config.cmake
      # Add the vcpkg overlay ports for system packages
      - type: dir
        path: overlays
        dest: overlays

      # Download meson as required by vcpkg-tool-meson
      - type: file
        url: https://github.com/mesonbuild/meson/archive/614d436232d3a86518164cbe2b8af12db3bde009.tar.gz
        sha256: e095d994ad3ae6a5b734cc6c7ef2375d6f72c4690b71b19d058b227a711c1ce7
        dest: vcpkg/downloads
        dest-filename: meson.tar.gz

      # Download pkgconf as required by MEGAsync for build
      - type: git
        url: https://github.com/pkgconf/pkgconf.git
        tag: pkgconf-2.2.0
        commit: 06120a8769aed87d50e914f87a6f9f67110cf16e
        dest: vcpkg/downloads/pkgconf/pkgconf

      - type: git
        url: https://github.com/c-ares/c-ares.git
        tag: v1.33.0
        commit: caffa5ffb3826cf0926405793361bbad11db3268
        dest: vcpkg/downloads/c-ares/c-ares

      - type: git
        url: https://github.com/abdes/cryptopp-cmake.git
        tag: CRYPTOPP_8_9_0
        commit: f815f6284684be6ab03af4b6c273359331c61241
        dest: vcpkg/downloads/abdes/cryptopp-cmake

      - type: git
        url: https://github.com/weidai11/cryptopp.git
        tag: CRYPTOPP_8_9_0
        commit: 843d74c7c97f9e19a615b8ff3c0ca06599ca501b
        dest: vcpkg/downloads/weidai11/cryptopp

      - type: git
        url: https://github.com/jedisct1/libsodium.git
        tag: 1.0.20-RELEASE
        commit: 9511c982fb1d046470a8b42aa36556cdb7da15de
        dest: vcpkg/downloads/jedisct1/libsodium

      - type: git
        url: https://github.com/madler/zlib.git
        tag: v1.3.1
        commit: 51b7f2abdade71cd9bb0e7a373ef2610ec6f9daf
        dest: vcpkg/downloads/madler/zlib

      - type: git
        url: https://github.com/libuv/libuv.git
        tag: v1.46.0
        commit: f0bb7e40f0508bedf6fad33769b3f87bb8aedfa6
        dest: vcpkg/downloads/libuv/libuv

      - type: git
        url: https://github.com/MediaArea/MediaInfoLib.git
        tag: v24.06
        commit: 547f070e74f1054ebd8ef17e36f8e9d7b6e53e92
        dest: vcpkg/downloads/MediaArea/MediaInfoLib

      - type: git
        url: https://github.com/leethomason/tinyxml2.git
        tag: 10.0.0
        commit: 321ea883b7190d4e85cae5512a12e5eaa8f8731f
        dest: vcpkg/downloads/leethomason/tinyxml2

      - type: git
        url: https://github.com/MediaArea/ZenLib.git
        tag: v0.4.41
        commit: 894980d3ecbc843d6ac685493f8f2ed5c2b6864c
        dest: vcpkg/downloads/MediaArea/ZenLib

      - type: git
        url: https://github.com/tukaani-project/xz.git
        tag: v5.6.2
        commit: 3ec664d3f652133136587a51d4505b1abe1acdd7
        dest: vcpkg/downloads/tukaani-project/xz

      - type: git
        url: https://github.com/ebiggers/libdeflate.git
        tag: v1.20
        commit: 275aa5141db6eda3587214e0f1d3a134768f557d
        dest: vcpkg/downloads/ebiggers/libdeflate

      - type: git
        url: https://github.com/meganz/MEGAsync.git
        tag: v5.4.1.0_Linux
        commit: 243d77ebb7239d7ff5cd8b7aea6c0158d1c6c813
        dest: desktop
        x-checker-data:
          type: json
          url: https://api.github.com/repos/meganz/MEGAsync/releases
          tag-query: map(select(.tag_name | endswith("_Linux"))) | first | .tag_name
          version-query: $tag | sub("^v"; "") | sub("_Linux$"; "")
          timestamp-query: map(select(.tag_name==$tag)) | first | .published_at
          is-main-source: true
      - type: patch
        dest: desktop
        paths:
          - patches/0020-build-patch-for-MEGASync.pro.patch
          - patches/0030-remove-obsolete-ffmpeg-macros.patch
          - patches/0040-set-DontUseNativeDialog-true.patch
          - patches/0050-remove-version-constraints.patch
  - name: xrdb
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/app/xrdb-1.2.2.tar.gz
        sha256: db2d774a35ae2f7e7ac61cc2de0dcae27fc2aa14399c35721f8300e63ea73549
        x-checker-data:
          type: html
          url: https://www.x.org/releases/individual/app/
          pattern: (xrdb-(\d\.\d+\.?\d*).tar.gz)
    modules:
      - name: libXmu
        sources:
          - type: archive
            url: https://www.x.org/releases/individual/lib/libXmu-1.2.1.tar.gz
            sha256: bf0902583dd1123856c11e0a5085bd3c6e9886fbbd44954464975fd7d52eb599
            x-checker-data:
              type: html
              url: https://www.x.org/releases/individual/lib/
              pattern: (libXmu-(\d\.\d+\.?\d*).tar.gz)
