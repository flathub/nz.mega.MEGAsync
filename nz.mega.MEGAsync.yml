id: nz.mega.MEGAsync
sdk: org.kde.Sdk
runtime: org.kde.Platform
runtime-version: 5.15-23.08
finish-args:
  - --device=dri
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  - --filesystem=~/MEGA:create
  - --filesystem=~/MEGAsync Downloads:create
  - --filesystem=~/MEGAsync:create
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
command: megasync
rename-icon: mega
copy-icon: true
rename-desktop-file: megasync.desktop
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man
modules:
  - name: MEGAsync
    buildsystem: simple
    build-options:
      env:
        DESKTOP_DESTDIR: /app
    build-commands:
      - cmake -DVCPKG_ROOT='vcpkg' -S 'desktop' -B 'build_dir' -DCMAKE_BUILD_TYPE=Release
      - cmake --build 'build_dir' --target MEGAsync
      - install -D build_dir/src/MEGASync/Release/megasync -t /app/bin/
    sources:
      - type: file
        url: https://github.com/chmln/sd/releases/download/v1.0.0/sd-v1.0.0-x86_64-unknown-linux-gnu.tar.gz
        sha256: 297202d8cc09cb65c9d7afdfc3f23146371d0c7d7d3448cecab11685d47c709a
      - type: shell
        commands:
          - tar -zxvf sd-v1.0.0-x86_64-unknown-linux-gnu.tar.gz --strip-components=1 sd-v1.0.0-x86_64-unknown-linux-gnu/sd
          - chmod +x sd
      - type: git
        url: https://github.com/microsoft/vcpkg.git
        tag: 2024.07.12
        commit: 1de2026f28ead93ff1773e6e680387643e914ea1
        dest: vcpkg
      - type: file
        url: https://github.com/microsoft/vcpkg-tool/releases/download/2024-07-10/vcpkg-glibc
        sha256: cdf7fdeb1327e20e2a47a6f7c9ec16999ebe29f417a9a673a80ac92c8b4d4243
        dest: vcpkg
        dest-filename: vcpkg
      - type: shell
        commands:
          - chmod +x vcpkg/vcpkg
          # - find . -type f -name 'portfile.cmake' -exec ./sd -f m 'vcpkg_from_.+?\(\s*?OUT_SOURCE_PATH\s+(\S+?)\s[^)]+?REPO\s+(\S+?)\s[^)]+?(PATCHES\s+[^)]+)+\)' 'set($1 "$2")\nvcpkg_apply_patches(\nSOURCE_PATH "$${$1}"\n$3)' {} +;
          - find . -type f -name 'portfile.cmake' -exec ./sd -f m 'vcpkg_from_.+?\(\s*?OUT_SOURCE_PATH\s+(\S+?)\s[^)]+?REPO\s+(\S+?)\s[^)]+\)' 'set($1 "$2")' {} +;
      - type: git
        url: https://github.com/c-ares/c-ares.git
        tag: v1.33.0
        commit: caffa5ffb3826cf0926405793361bbad11db3268
        dest: c-ares/c-ares
      - type: git
        url: https://github.com/abdes/cryptopp-cmake.git
        tag: CRYPTOPP_8_9_0
        commit: f815f6284684be6ab03af4b6c273359331c61241
        dest: abdes/cryptopp-cmake
      - type: git
        url: https://github.com/weidai11/cryptopp.git
        tag: CRYPTOPP_8_9_0
        commit: 843d74c7c97f9e19a615b8ff3c0ca06599ca501b
        dest: weidai11/cryptopp
      - type: git
        url: https://github.com/MediaArea/MediaInfoLib.git
        tag: v24.06
        commit: 547f070e74f1054ebd8ef17e36f8e9d7b6e53e92
        dest: MediaArea/MediaInfoLib
      - type: git
        url: https://github.com/meganz/MEGAsync.git
        tag: v5.4.0.0_Linux
        commit: 1057c438ccedafcec8f3b2dac7b3c3cfd6d9d07f
        dest: desktop
        x-checker-data:
          type: json
          url: https://api.github.com/repos/meganz/MEGAsync/releases
          tag-query: map(select(.tag_name | endswith("_Linux"))) | first | .tag_name
          version-query: $tag | sub("^v"; "") | sub("_Linux$"; "")
          timestamp-query: map(select(.tag_name==$tag)) | first | .published_at
          is-main-source: true
      - type: patch
        dest: desktop
        paths:
          - patches/0020-build-patch-for-MEGASync.pro.patch
          - patches/0030-remove-obsolete-ffmpeg-macros.patch
          - patches/0040-set-DontUseNativeDialog-true.patch
          - patches/0050-remove-version-constraints.patch
  - name: xrdb
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/app/xrdb-1.2.2.tar.gz
        sha256: db2d774a35ae2f7e7ac61cc2de0dcae27fc2aa14399c35721f8300e63ea73549
        x-checker-data:
          type: html
          url: https://www.x.org/releases/individual/app/
          pattern: (xrdb-(\d\.\d+\.?\d*).tar.gz)
    modules:
      - name: libXmu
        sources:
          - type: archive
            url: https://www.x.org/releases/individual/lib/libXmu-1.2.1.tar.gz
            sha256: bf0902583dd1123856c11e0a5085bd3c6e9886fbbd44954464975fd7d52eb599
            x-checker-data:
              type: html
              url: https://www.x.org/releases/individual/lib/
              pattern: (libXmu-(\d\.\d+\.?\d*).tar.gz)
