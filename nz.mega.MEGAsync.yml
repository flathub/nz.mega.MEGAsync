id: nz.mega.MEGAsync
sdk: org.kde.Sdk
runtime: org.kde.Platform
runtime-version: 5.15-23.08
add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    version: '23.08'
    add-ld-path: .
finish-args:
  - --device=dri
  - --env=XCURSOR_PATH=/run/host/user-share/icons:/run/host/share/icons
  - --filesystem=~/MEGA:create
  - --filesystem=~/MEGAsync Downloads:create
  - --filesystem=~/MEGAsync:create
  - --share=ipc
  - --share=network
  - --socket=pulseaudio
  - --socket=wayland
  - --socket=x11
  - --talk-name=org.freedesktop.Notifications
  - --talk-name=org.kde.StatusNotifierWatcher
command: megasync
rename-icon: mega
copy-icon: true
rename-desktop-file: megasync.desktop
cleanup:
  - "*.a"
  - "*.la"
  - /include
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man
modules:
  - name: MEGAsync
    buildsystem: simple
    build-options:
      env:
        DESKTOP_DESTDIR: /app
    build-commands:
      - find vcpkg/ports desktop/src/MEGASync/mega/contrib/cmake/vcpkg_overlay_ports -name 'portfile.cmake' -type f -fprint0 PORTFILES
      - xargs -0 ./sd -f m 'vcpkg_from_.+?\(\s*?OUT_SOURCE_PATH\s+(\S+?)\s[^)]+?(?:REPO|REF)\s+(\S+?)\s[^)]+?(PATCHES\s+[^)]+)+\)' 'set($1 "downloads/$2")\nz_vcpkg_apply_patches(\nSOURCE_PATH "$${$1}"\n$3)' < PORTFILES
      - xargs -0 ./sd -f m 'vcpkg_from_.+?\(\s*?OUT_SOURCE_PATH\s+(\S+?)\s[^)]+?(?:REPO|REF)\s+(\S+?)\s[^)]+\)' 'set($1 "downloads/$2")' < PORTFILES
      - xargs -0 ./sd -f m '(vcpkg_cmake_configure|vcpkg_configure_\w+)\(' 'file(RENAME $${SOURCE_PATH} $${CURRENT_BUILDTREES_DIR}/$${TARGET_TRIPLET}-$${BUILD_TYPE})\nset(SOURCE_PATH "$${CURRENT_BUILDTREES_DIR}/$${TARGET_TRIPLET}-$${BUILD_TYPE}")\n$1(' < PORTFILES
      
      - ./sd -f m 'pdfium_from_git\([^\)]+\)' '' desktop/src/MEGASync/mega/contrib/cmake/vcpkg_overlay_ports/pdfium/portfile.cmake
      - ./sd -f m 'if\(SOURCE_PATH MATCHES " "\)' 'file(RENAME $${SOURCE_PATH} $${CURRENT_BUILDTREES_DIR}/$${TARGET_TRIPLET}-$${BUILD_TYPE})\nset(SOURCE_PATH "$${CURRENT_BUILDTREES_DIR}/$${TARGET_TRIPLET}-$${BUILD_TYPE}")\nif(SOURCE_PATH MATCHES " ")' desktop/src/MEGASync/mega/contrib/cmake/vcpkg_overlay_ports/ffmpeg/portfile.cmake

      # - ./sd -f m '\+    find_package\(lcms2 CONFIG REQUIRED\)' '+    find_package(LCMS2)' desktop/src/MEGASync/mega/contrib/cmake/vcpkg_overlay_ports/libraw/dependencies.patch
      # - ./sd -f m '\+    set\(LCMS2_' '+    set(XLCMS2_' desktop/src/MEGASync/mega/contrib/cmake/vcpkg_overlay_ports/libraw/dependencies.patch
      # - ./sd -f m 'WebP CONFIG' 'WebP' vcpkg/ports/freeimage/CMakeLists.txt
      # - cp vcpkg/ports/freeimage/CMakeLists.txt vcpkg/downloads/freeimage/Source%20Distribution

      - find . -name '*.cmake' -type f -fprint0 CMAKEFILES
      - xargs -0 ./sd -f m 'vcpkg_find_acquire_program\(PATCHELF\)' '' < CMAKEFILES
      - xargs -0 ./sd -f m '\$\{PATCHELF\}' 'patchelf' < CMAKEFILES

      - ./sd -f m 'vcpkg_download_distfile\(archive_path[^)]+\)' 'set(archive_path "downloads/meson.tar.gz")' vcpkg/ports/vcpkg-tool-meson/vcpkg-port-config.cmake
      - ./sd -f m 'vcpkg_download_distfile\(ARCHIVE[^)]+\)' '' vcpkg/ports/bzip2/portfile.cmake
      - ./sd -f m 'vcpkg_extract_source_archive\([^)]+\)' 'set(SOURCE_PATH "downloads/bzip2")' vcpkg/ports/bzip2/portfile.cmake

      - cmake -S 'desktop' -B 'build_dir' -DVCPKG_ROOT='vcpkg' -DVCPKG_OVERLAY_PORTS='overlays' -DCMAKE_BUILD_TYPE=Release
      - cmake --build 'build_dir' --target MEGAsync
      - install -D build_dir/src/MEGASync/Release/megasync -t /app/bin/
    sources:
      # Use sd instead of sed for better regex multiline matching
      - type: archive
        url: https://github.com/chmln/sd/releases/download/v1.0.0/sd-v1.0.0-x86_64-unknown-linux-gnu.tar.gz
        sha256: 297202d8cc09cb65c9d7afdfc3f23146371d0c7d7d3448cecab11685d47c709a
        strip-components: 1

      # Download patchelf as required by vcpkg_find_acquire_program(PATCHELF)
      - type: archive
        url: https://github.com/NixOS/patchelf/releases/download/0.14.5/patchelf-0.14.5-x86_64.tar.gz
        sha256: 514bb05d8f0e41ea0a6cb999041acb6aa386662e9ccdbdfbbfca469fb22d44fa
        strip-components: 2
      
      # Download vcpkg which contains the cmake and portfiles of dependencies
      - type: git
        url: https://github.com/microsoft/vcpkg.git
        branch: master
        dest: vcpkg

      # Download vcpkg-tool which will be used by vcpkg-cmake
      - type: file
        url: https://github.com/microsoft/vcpkg-tool/releases/download/2024-08-01/vcpkg-glibc
        sha256: da93a3693911c15406e0a9d2562c0db142ee63b77e4268ab55ea9e87b390ec7b
        dest: vcpkg
        dest-filename: vcpkg
      - type: shell
        commands:
          - chmod +x vcpkg/vcpkg
      # Add the vcpkg overlay ports for system packages
      - type: dir
        path: overlays
        dest: overlays

      # Download meson as required by vcpkg-tool-meson
      - type: file
        url: https://github.com/mesonbuild/meson/archive/1.5.1.tar.gz
        sha256: 55f6acd5bf72c14d4aa5a781993633f84a1d117bdf2c2057735902ced9b81390
        dest: vcpkg/downloads
        dest-filename: meson.tar.gz

      - type: archive
        url: https://nchc.dl.sourceforge.net/project/freeimage/Source%20Distribution/3.18.0/FreeImage3180.zip
        sha256: f41379682f9ada94ea7b34fe86bf9ee00935a3147be41b6569c9605a53e438fd
        strip-components: 1
        dest: vcpkg/downloads/freeimage/Source%20Distribution

      # Download pkgconf as required by MEGAsync for build
      - type: git
        url: https://github.com/pkgconf/pkgconf.git
        tag: pkgconf-2.3.0
        commit: a88c0d962a987c62d98ede5a738e37ec71005cbd
        dest: vcpkg/downloads/pkgconf/pkgconf

      - type: git
        url: https://github.com/c-ares/c-ares.git
        tag: v1.33.0
        commit: caffa5ffb3826cf0926405793361bbad11db3268
        dest: vcpkg/downloads/c-ares/c-ares

      - type: git
        url: https://github.com/abdes/cryptopp-cmake.git
        tag: CRYPTOPP_8_9_0
        commit: f815f6284684be6ab03af4b6c273359331c61241
        dest: vcpkg/downloads/abdes/cryptopp-cmake

      - type: git
        url: https://github.com/weidai11/cryptopp.git
        tag: CRYPTOPP_8_9_0
        commit: 843d74c7c97f9e19a615b8ff3c0ca06599ca501b
        dest: vcpkg/downloads/weidai11/cryptopp

      - type: git
        url: https://github.com/ffmpeg/ffmpeg.git
        tag: n5.1.2
        commit: eacfcbae690f914a4b1b4ad06999f138540cc3d8
        dest: vcpkg/downloads/ffmpeg/ffmpeg

      - type: git
        url: https://github.com/jedisct1/libsodium.git
        tag: 1.0.20-RELEASE
        commit: 9511c982fb1d046470a8b42aa36556cdb7da15de
        dest: vcpkg/downloads/jedisct1/libsodium

      - type: git
        url: https://github.com/madler/zlib.git
        tag: v1.3.1
        commit: 51b7f2abdade71cd9bb0e7a373ef2610ec6f9daf
        dest: vcpkg/downloads/madler/zlib

      - type: git
        url: https://github.com/libuv/libuv.git
        tag: v1.48.0
        commit: e9f29cb984231524e3931aa0ae2c5dae1a32884e
        dest: vcpkg/downloads/libuv/libuv

      - type: git
        url: https://github.com/MediaArea/MediaInfoLib.git
        tag: v24.06
        commit: 547f070e74f1054ebd8ef17e36f8e9d7b6e53e92
        dest: vcpkg/downloads/MediaArea/MediaInfoLib

      - type: git
        url: https://github.com/leethomason/tinyxml2.git
        tag: 10.0.0
        commit: 321ea883b7190d4e85cae5512a12e5eaa8f8731f
        dest: vcpkg/downloads/leethomason/tinyxml2

      - type: git
        url: https://github.com/MediaArea/ZenLib.git
        tag: v0.4.41
        commit: 894980d3ecbc843d6ac685493f8f2ed5c2b6864c
        dest: vcpkg/downloads/MediaArea/ZenLib

      - type: git
        url: https://github.com/tukaani-project/xz.git
        tag: v5.6.2
        commit: 3ec664d3f652133136587a51d4505b1abe1acdd7
        dest: vcpkg/downloads/tukaani-project/xz

      - type: git
        url: https://github.com/ebiggers/libdeflate.git
        tag: v1.21
        commit: 9be1c54e6086cd1f9e1e7dece96eb6d1355c93f7
        dest: vcpkg/downloads/ebiggers/libdeflate

      - type: git
        url: https://github.com/AcademySoftwareFoundation/Imath.git
        tag: v3.1.11
        commit: 5ac1d5335cb34f0f356c5f2461a57c845b96b115
        dest: vcpkg/downloads/AcademySoftwareFoundation/Imath

      - type: git
        url: https://github.com/AcademySoftwareFoundation/openexr.git
        tag: v3.2.4
        commit: a1a00ffeecf627bbbc010d40700720bee48b2af7
        dest: vcpkg/downloads/AcademySoftwareFoundation/openexr

      - type: git
        url: https://github.com/LibRaw/LibRaw.git
        tag: 0.21.1
        commit: cccb97647fcee56801fa68231fa8a38aa8b52ef7
        dest: vcpkg/downloads/LibRaw/LibRaw

      - type: git
        url: https://github.com/LibRaw/LibRaw-cmake.git
        commit: 6e26c9e73677dc04f9eb236a97c6a4dc225ba7e8
        dest: vcpkg/downloads/LibRaw/LibRaw-cmake

      - type: git
        url: https://pdfium.googlesource.com/pdfium.git
        commit: ee44620f2b58999b0d272d58fa0b994d5935f688
        dest: vcpkg/downloads/ee44620f2b58999b0d272d58fa0b994d5935f688

      - type: git
        url: https://chromium.googlesource.com/chromium/src/build.git
        commit: 26f8da34750ac3bccf683ed5f70d86f21c54b22b
        dest: vcpkg/downloads/ee44620f2b58999b0d272d58fa0b994d5935f688/build

      - type: git
        url: https://chromium.googlesource.com/chromium/src/third_party/abseil-cpp.git
        commit: 62a4d6866aeeca02036c510b2f3f286084dd62af
        dest: vcpkg/downloads/ee44620f2b58999b0d272d58fa0b994d5935f688/third_party/abseil-cpp

      - type: git
        url: https://github.com/4creators/jxrlib.git
        tag: v2019.10.9
        commit: f7521879862b9085318e814c6157490dd9dbbdb4
        dest: vcpkg/downloads/4creators/jxrlib

      - type: git
        url: https://github.com/jasper-software/jasper.git
        tag: version-4.2.1
        commit: 7359c0dfa505c9d710233b8724690a4407c4702d
        dest: vcpkg/downloads/jasper-software/jasper

      - type: git
        url: https://github.com/webmproject/libwebp.git
        tag: v1.4.0
        commit: 845d5476a866141ba35ac133f856fa62f0b7445f
        dest: vcpkg/downloads/webmproject/libwebp

      - type: git
        url: https://github.com/mm2/Little-CMS.git
        tag: lcms2.14
        commit: e88d9bcad79b7ebf6b97ebd634af31ed23c1b910
        dest: vcpkg/downloads/mm2/Little-CMS

      - type: git
        url: https://github.com/glennrp/libpng.git
        tag: v.1.6.43
        commit: ed217e3e601d8e462f7fd1e04bed43ac42212429
        dest: vcpkg/downloads/glennrp/libpng

      - type: archive
        url: https://sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz
        mirror-urls:
          - https://www.mirrorservice.org/sites/sourceware.org/pub/bzip2/bzip2-1.0.8.tar.gz
        sha256: ab5a03176ee106d3f0fa90e381da478ddae405918153cca248e682cd0c4a2269
        strip-components: 1
        dest: vcpkg/downloads/bzip2

      - type: git
        url: https://github.com/meganz/MEGAsync.git
        tag: v5.4.1.0_Linux
        commit: 243d77ebb7239d7ff5cd8b7aea6c0158d1c6c813
        dest: desktop
        x-checker-data:
          type: json
          url: https://api.github.com/repos/meganz/MEGAsync/releases
          tag-query: map(select(.tag_name | endswith("_Linux"))) | first | .tag_name
          version-query: $tag | sub("^v"; "") | sub("_Linux$"; "")
          timestamp-query: map(select(.tag_name==$tag)) | first | .published_at
          is-main-source: true
      - type: patch
        dest: desktop
        paths:
          - patches/0020-build-patch-for-MEGASync.pro.patch
          - patches/0030-remove-obsolete-ffmpeg-macros.patch
          - patches/0040-set-DontUseNativeDialog-true.patch
          - patches/0050-remove-version-constraints.patch
  - name: xrdb
    sources:
      - type: archive
        url: https://www.x.org/releases/individual/app/xrdb-1.2.2.tar.gz
        sha256: db2d774a35ae2f7e7ac61cc2de0dcae27fc2aa14399c35721f8300e63ea73549
        x-checker-data:
          type: html
          url: https://www.x.org/releases/individual/app/
          pattern: (xrdb-(\d\.\d+\.?\d*).tar.gz)
    modules:
      - name: libXmu
        sources:
          - type: archive
            url: https://www.x.org/releases/individual/lib/libXmu-1.2.1.tar.gz
            sha256: bf0902583dd1123856c11e0a5085bd3c6e9886fbbd44954464975fd7d52eb599
            x-checker-data:
              type: html
              url: https://www.x.org/releases/individual/lib/
              pattern: (libXmu-(\d\.\d+\.?\d*).tar.gz)
